<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sr. Mastrius ‚Äî English Mastery</title>
<!-- ====== STYLE (Premium, clean) ====== -->
<style>
  :root{
    --brand:#31c1bb; --brand-2:#f5b305; --accent:#e34410; --ink:#0C0101;
    --bg:#f6f9fb; --card:#ffffff; --muted:#64748b; --line:#e6edf0;
  }
  *{box-sizing:border-box}  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f9ffff,#eefbfa 60%,#fff);color:#0f172a}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .brand{display:flex;gap:14px;align-items:center}
  .title{font-weight:800;letter-spacing:.2px}
  .sub{font-size:13px;color:var(--muted)}
  .badge{display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px dashed #d1e6e6;background:#fff;color:#334155;font-size:13px}
  .app{background:var(--card);border:1px solid rgba(12,1,1,.06);border-radius:20px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
  .screen{display:none} .screen.active{display:block}
  .card{background:#fff;border:1px solid rgba(12,1,1,.08);border-radius:16px;padding:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .08s ease,background .2s ease}
  .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 16px rgba(227,68,16,.25)}
  .btn.primary:hover{transform:translateY(-1px)}
  .btn.secondary{background:#fff;border:1px solid rgba(12,1,1,.18)}
  .muted{font-size:13px;color:var(--muted)}
  .grid{display:grid;gap:14px}
  @media (min-width:900px){ .grid-2{grid-template-columns:1.2fr .8fr} }
  input,textarea,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #dbe5ea;background:#fff;font-size:14px}
  .chat{height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:12px;background:#fff;border-radius:14px;border:1px solid rgba(12,1,1,.08)}
  .msg{max-width:85%;padding:10px 14px;border-radius:12px;white-space:pre-wrap;line-height:1.45}
  .bot{align-self:flex-start;background:#fff;border:1px solid rgba(12,1,1,.12);animation:fade .25s ease}
  .me{align-self:flex-end;background:#e7fff9;border:1px solid rgba(49,193,187,.35);animation:fade .25s ease}
  @keyframes fade{from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none}}
  .controls{display:flex;gap:8px;margin-top:10px}
  .status{font-size:12px;color:#64748b;margin-top:6px}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:13px;cursor:pointer}
  .ring{position:relative;width:92px;height:92px;display:grid;place-items:center}
  .ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
  .ring .bg{stroke:#e6edf0;stroke-width:10;fill:none}
  .ring .fg{stroke:var(--brand);stroke-linecap:round;stroke-width:10;fill:none;transition:stroke-dashoffset .4s ease}
  .avatar{width:72px;height:72px;border-radius:999px;border:1px solid rgba(12,1,1,.08);display:grid;place-items:center;background:#fff}
  .avatar svg{width:64px;height:64px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="ring">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle class="bg" cx="50" cy="50" r="42"></circle>
          <circle id="ring" class="fg" cx="50" cy="50" r="42" stroke-dasharray="264" stroke-dashoffset="264"></circle>
        </svg>
        <div class="avatar" aria-label="Sr. Mastrius">
          <!-- avatar cartoon 30‚Äì40, casual, busto -->
          <svg viewBox="0 0 128 128">
            <circle cx="64" cy="64" r="62" fill="#fff"/>
            <circle cx="64" cy="52" r="22" fill="#f2d3c2"/>
            <rect x="38" y="86" width="52" height="28" rx="14" fill="#31c1bb"/>
            <path d="M40,96 Q64,82 88,96 L88,112 L40,112 Z" fill="#0C0101" opacity=".12"/>
            <circle cx="56" cy="50" r="3" fill="#0C0101"/><circle cx="72" cy="50" r="3" fill="#0C0101"/>
            <path d="M54,65 q10,6 20,0" stroke="#e34410" stroke-width="3" fill="none"/>
            <rect x="50" y="26" width="28" height="12" rx="6" fill="#0C0101"/>
          </svg>
        </div>
      </div>
      <div>
        <div class="title">Sr. Mastrius ‚Äî English Mastery</div>
        <div class="sub">Experi√™ncia premium. Teste inteligente. Coaching personalizado.</div>
      </div>
    </div>
    <div class="badge" id="badge"><span>üéÅ</span><span id="badgeText">Resultado + Speaking Test bloqueado</span></div>
  </header>

  <main class="app">
    <!-- ===== WELCOME ===== -->
    <section id="scr-welcome" class="screen active card">
      <p style="margin-top:0">
        <strong>Bem-vindo(a) ao English Mastery.</strong><br/>
        Eu sou o <strong>Sr. Mastrius</strong>, seu mentor de ingl√™s. Vamos descobrir seu n√≠vel e tra√ßar um plano claro para desbloquear seu ingl√™s?
      </p>
      <div class="row">
        <button class="btn primary" id="startIntake">Fazer teste de n√≠vel</button>
        <button class="btn secondary" id="goLogin">Sou aluno EM</button>
      </div>
      <div class="muted" style="margin-top:6px">R√°pido, preciso e humano. Em ~7 minutos voc√™ tem um diagn√≥stico claro.</div>
    </section>

    <!-- ===== INTAKE (4 perguntas curtas) ===== -->
    <section id="scr-intake" class="screen card">
      <div class="grid">
        <div>
          <label>1) J√° estudou ingl√™s antes? Por quanto tempo?</label>
          <input id="q1" placeholder="Ex.: 1 ano em curso livre, 6 meses sozinho..." />
        </div>
        <div>
          <label>2) Como voc√™ se sente em rela√ß√£o ao seu ingl√™s?</label>
          <select id="q2">
            <option value="">Selecione‚Ä¶</option>
            <option>Confiante</option><option>Ok, mas inseguro(a)</option><option>Travado(a)</option>
          </select>
        </div>
        <div>
          <label>3) Seu maior desafio hoje?</label>
          <input id="q3" placeholder="Ex.: falar sem travar, listening, reuni√µes..." />
        </div>
        <div>
          <label>4) O que voc√™ quer alcan√ßar em 6 meses?</label>
          <input id="q4" placeholder="Ex.: entrevista, viagem, trabalho, B2..." />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="startPlacement">Come√ßar avalia√ß√£o</button>
        <button class="btn secondary" id="backWelcome">Voltar</button>
      </div>
      <div class="muted">Usaremos isso para personalizar o teste e o coaching.</div>
    </section>

    <!-- ===== PLACEMENT ===== -->
    <section id="scr-placement" class="screen">
      <div class="grid grid-2">
        <div class="card">
          <div id="pChat" class="chat" aria-live="polite"></div>
          <div class="controls">
            <input id="pInput" placeholder="Type your answer in English‚Ä¶" autocomplete="off"/>
            <button id="pSend" class="btn primary">Send</button>
          </div>
          <div id="pStatus" class="status"></div>
        </div>
        <aside class="card">
          <div class="muted"><strong>Progresso</strong></div>
          <div style="font-size:13px"><span id="pProg">0%</span> ‚Äî <span id="pTier">A1</span> ‚Ä¢ Confian√ßa <span id="pConf">0.00</span></div>
          <div style="margin-top:10px"><span id="reward" class="pill">üîí Resultado bloqueado</span></div>
          <div style="margin-top:14px" class="muted">Responda naturalmente. Curto e direto funciona melhor.</div>
        </aside>
      </div>
    </section>

    <!-- ===== GATE LEAD ===== -->
    <section id="scr-gate" class="screen card">
      <p class="msg bot"><strong>Excelente!</strong> Para ver seu <strong>diagn√≥stico</strong> (pontos fortes, foco e n√≠vel estimado) e liberar sua <strong>sess√£o gratuita</strong>, preencha abaixo:</p>
      <div class="grid">
        <input id="leadName" placeholder="Nome completo" />
        <input id="leadEmail" type="email" placeholder="E-mail" />
        <input id="leadWhats" placeholder="WhatsApp (com DDD)" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="sendLead" class="btn primary">Ver diagn√≥stico & desbloquear</button>
        <button id="gateBack" class="btn secondary">Voltar</button>
      </div>
      <div id="leadStatus" class="status"></div>
    </section>

    <!-- ===== RESULT ===== -->
    <section id="scr-result" class="screen card">
      <div id="result" class="msg bot">Gerando seu diagn√≥stico‚Ä¶</div>
      <div class="row" style="margin-top:10px">
        <a class="pill" href="https://calendly.com/carloseduardo-englishmastery/30min" target="_blank" rel="noopener">üìÖ Agendar Speaking Test (30min)</a>
        <button id="goCoach" class="btn primary">Ir para Conversa√ß√£o</button>
      </div>
    </section>

    <!-- ===== LOGIN EM ===== -->
    <section id="scr-login" class="screen card">
      <p class="msg bot">Acesso de alunos EM. Digite nome e sobrenome e a senha para desbloquear o modo de conversa√ß√£o.</p>
      <div class="row">
        <input id="lgName" placeholder="Nome" />
        <input id="lgLast" placeholder="Sobrenome" />
        <input id="lgPass" type="password" placeholder="Senha" />
      </div>
      <div class="row" style="margin-top:12px"><button id="lgEnter" class="btn primary">Entrar</button></div>
      <div id="lgStatus" class="status"></div>
    </section>

    <!-- ===== COACHING ===== -->
    <section id="scr-coach" class="screen">
      <div class="grid grid-2">
        <div class="card">
          <div id="cChat" class="chat"></div>
          <div class="controls">
            <input id="cInput" placeholder="Talk to Sr. Mastrius‚Ä¶" autocomplete="off"/>
            <button id="cSend" class="btn primary">Send</button>
          </div>
          <div id="cStatus" class="status"></div>
        </div>
        <aside class="card">
          <div class="sub"><strong>Temas sugeridos</strong></div>
          <div id="topics" class="row" style="margin-top:6px"></div>
          <div class="muted" style="margin-top:8px">As sugest√µes ficam mais relevantes conforme voc√™ usa.</div>
        </aside>
      </div>
    </section>
  </main>
</div>

<!-- ====== LOGIC ====== -->
<script>
const $ = id => document.getElementById(id);
const screens = ['scr-welcome','scr-intake','scr-placement','scr-gate','scr-result','scr-login','scr-coach'];
let SESSION_ID = null;
let placementSummary = {score:0, correct:0, wrong:0, level:'A1', confidence:0, tags:[]};
let intake = null;

function show(id){ screens.forEach(s=>$(s).classList.remove('active')); $(id).classList.add('active'); }
function ring(p){ const total=264, off=total-total*Math.max(0,Math.min(1,p)); $('ring').style.strokeDashoffset = String(off); }
function addMsg(el, text, who='bot'){ const d=document.createElement('div'); d.className='msg '+who; d.textContent=text; el.appendChild(d); el.scrollTop=el.scrollHeight; }

async function startSession(){
  const r = await fetch('/session/start',{method:'POST'}); const j = await r.json();
  SESSION_ID = j.sessionId;
}
startSession();

/* ---- welcome ‚Üí intake ---- */
$('startIntake').onclick = ()=> show('scr-intake');
$('goLogin').onclick   = ()=> show('scr-login');
$('backWelcome').onclick = ()=> show('scr-welcome');

/* ---- intake ‚Üí placement ---- */
$('startPlacement').onclick = ()=>{
  intake = {
    exp: $('q1').value.trim(),
    feel: $('q2').value,
    pain: $('q3').value.trim(),
    dream: $('q4').value.trim()
  };
  show('scr-placement');
  startPlacement();
};

/* ===================== PLACEMENT ===================== */
const pChat=$('pChat');
function pSay(t){ addMsg(pChat,t,'bot'); }
function uSay(t){ addMsg(pChat,t,'me'); }
async function placementNext(lastAnswer){
  const r = await fetch('/placement/next',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ sessionId: SESSION_ID, lastAnswer })
  });
  return await r.json();
}
async function startPlacement(){
  pChat.innerHTML=''; ring(0); $('badge').classList.add('locked'); $('badgeText').textContent='Resultado + Speaking Test bloqueado';
  pSay('Perfeito. Responda em ingl√™s de forma breve e natural. Ready?');
  const first = await placementNext();
  if(first?.question){ pSay(first.question); $('pStatus').textContent='Question 1 of ~7'; $('pTier').textContent=first.tier||'A1'; }
}
$('pSend').onclick = async ()=>{
  const val=$('pInput').value.trim(); if(!val) return; $('pInput').value=''; uSay(val);
  const nxt = await placementNext(val);
  if(nxt.done){
    // estimativa final
    placementSummary.level = nxt.estimate || 'A2';
    placementSummary.confidence = nxt.confidence || 0;
    $('reward').textContent='üîì Recompensa desbloqueada';
    $('badge').classList.remove('locked'); $('badgeText').textContent='üéÅ Recompensa desbloqueada';
    show('scr-gate');
    return;
  }
  const stepText = Math.round((nxt.progress||0)*100);
  ring(nxt.progress||0);
  $('pProg').textContent = `${stepText}%`;
  $('pTier').textContent = nxt.tier || 'A1';
  $('pConf').textContent = (nxt.confidence||0).toFixed(2);
  $('pStatus').textContent = `Progress ${stepText}%`;
  if(nxt.question) pSay(nxt.question);
};

/* ===================== GATE / LEAD ===================== */
$('gateBack').onclick = ()=> show('scr-placement');
$('sendLead').onclick = async ()=>{
  const name=$('leadName').value.trim(), email=$('leadEmail').value.trim(), whats=$('leadWhats').value.trim();
  if(!name||!email||!whats){ $('leadStatus').textContent='Preencha nome, e-mail e WhatsApp.'; return; }
  $('leadStatus').textContent='Enviando‚Ä¶';

  // salva local (MVP)
  localStorage.setItem('em_lead', JSON.stringify({name,email,whats, level:placementSummary.level, ts:Date.now(), intake}));

  // envia p/ backend ‚Üí Formspree
  try{
    await fetch('/lead',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name, email, whats,
        placement:{ level:placementSummary.level, score:0, correct:0, wrong:0, tags:[] },
        meta:{ ua:navigator.userAgent }
      })
    });
    $('leadStatus').textContent='Ok! Gerando diagn√≥stico‚Ä¶';
  }catch(_){ $('leadStatus').textContent='Enviado (offline).'; }

  // diagn√≥stico simples
  const diag = [
    `Estimated level: ${placementSummary.level}`,
    `Strengths: clear communication on everyday topics`,
    `Focus next: build range (connectors, reasons) and natural phrasing`,
    intake?.pain ? `We‚Äôll address your main challenge: ${intake.pain}` : '',
    intake?.dream ? `Plan aligned with your 6-month goal: ${intake.dream}` : ''
  ].filter(Boolean).join('\n');

  $('result').textContent = `Your diagnostic\n\n${diag}\n\nGreat job! Click below to book your free speaking test.`;
  show('scr-result');
};

/* ===================== LOGIN EM ===================== */
$('lgEnter').onclick = async ()=>{
  const name=$('lgName').value.trim(), last=$('lgLast').value.trim(), pass=$('lgPass').value.trim();
  if(!name||!last||!pass){ $('lgStatus').textContent='Preencha todos os campos.'; return; }
  $('lgStatus').textContent='Verificando‚Ä¶';
  const r = await fetch('/auth/student',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,last,pass})});
  const j = await r.json();
  if(!j.ok){ $('lgStatus').textContent='Senha inv√°lida.'; return; }
  localStorage.setItem('em_login',(name+last).replace(/\s+/g,'').toLowerCase());
  $('lgStatus').textContent='Acesso liberado.';
  setTimeout(()=> show('scr-coach'), 400);
};

/* ===================== COACHING ===================== */
const cChat=$('cChat');
function cSay(t){ addMsg(cChat,t,'bot'); }
function meSay(t){ addMsg(cChat,t,'me'); }
const TOPICS = {
  A1:["Daily greetings","Food & drinks","Family & friends","Hobbies"],
  A2:["Travel & trips","Routine & schedules","Shopping & services","Health basics"],
  B1:["Work meetings","Opinions & debates","Past projects","Plans & goals"]
};
function renderTopics(level){
  const box=$('topics'); box.innerHTML='';
  (TOPICS[level]||TOPICS.A2).forEach(t=>{
    const b=document.createElement('button'); b.className='pill'; b.textContent=t;
    b.onclick=()=> sendCoach(`Let's practice: ${t}. Ask me questions and help me improve.`);
    box.appendChild(b);
  });
}
async function sendCoach(text){
  if(!text){ text=$('cInput').value.trim(); $('cInput').value=''; }
  if(!text) return;
  meSay(text); $('cStatus').textContent='Thinking‚Ä¶';
  try{
    const r=await fetch('/respond',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:SESSION_ID,text})});
    const j=await r.json();
    if(!r.ok||!j?.ok){ cSay('Server error, please try again.'); }
    else { cSay(j.text); }
  }catch(_){ cSay('Connection error.'); }
  $('cStatus').textContent='';
}
$('cSend').onclick = ()=> sendCoach();
$('cInput').addEventListener('keydown',e=>{ if(e.key==='Enter') sendCoach(); });
$('goCoach').onclick = ()=>{
  renderTopics(placementSummary.level||'A2');
  cChat.innerHTML='';
  cSay(`Welcome to conversation mode. I‚Äôll keep it light, helpful and motivating. Ready to talk about something you enjoy?`);
  show('scr-coach');
};

/* ============ INIT ============ */
ring(0);
</script>
</body>
</html>
