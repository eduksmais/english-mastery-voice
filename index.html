<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sr. Mastrius ‚Äî English Mastery Coach</title>
<style>
  :root {
    --teal:#31c1bb; --yellow:#f5b305; --orange:#e34410; --black:#0C0101; --white:#ffffff;
    --bg:#f7fafb; --card:#ffffff; --muted:#6b7280; --ring:#e6edf0;
  }
  * { box-sizing:border-box }
  body {
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:linear-gradient(180deg,#f9ffff, #eefbfa 60%, #ffffff);
    color:#0f172a; display:flex; align-items:center; justify-content:center; min-height:100dvh; padding:16px;
  }
  .app {
    width:min(960px,100%); background:var(--card); border-radius:18px; padding:18px;
    border:1px solid rgba(12,1,1,.07); box-shadow:0 10px 30px rgba(0,0,0,.07);
  }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px }
  .brand { display:flex; align-items:center; gap:12px }
  .title { font-weight:800; letter-spacing:.2px }
  .sub { font-size:13px; color:var(--muted) }

  /* Avatar + progress ring */
  .hero { display:flex; gap:18px; align-items:center }
  .ring {
    position:relative; width:92px; height:92px;
    display:grid; place-items:center;
  }
  .ring svg { position:absolute; inset:0; transform:rotate(-90deg) }
  .ring .bg { stroke:var(--ring); stroke-width:10; fill:none }
  .ring .fg { stroke:var(--teal); stroke-linecap:round; stroke-width:10; fill:none; transition:stroke-dashoffset .4s ease }
  .avatar {
    width:72px; height:72px; border-radius:999px; overflow:hidden; display:grid; place-items:center; background:#fff; border:1px solid rgba(12,1,1,.08)
  }
  /* Avatar cartoon (busto) em SVG inline */
  .avatar svg { width:64px; height:64px }

  .badge { display:flex; align-items:center; gap:8px; border:1px dashed rgba(12,1,1,.15);
    padding:8px 12px; border-radius:999px; background:#fff; color:#374151; font-size:13px }
  .badge.locked { opacity:.7 }

  .screen { display:none }
  .screen.active { display:block }

  .card {
    border:1px solid rgba(12,1,1,.08); border-radius:16px; background:var(--bg); padding:16px;
  }

  /* Chat */
  .chat { height:420px; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:12px; background:#fff; border-radius:14px; border:1px solid rgba(12,1,1,.08) }
  .bubble { max-width:85%; padding:10px 14px; border-radius:12px; line-height:1.45; white-space:pre-wrap }
  .bot { align-self:flex-start; background:#fff; border:1px solid rgba(12,1,1,.1) }
  .user { align-self:flex-end; background:#e7fff9; border:1px solid rgba(49,193,187,.35) }
  .controls { display:flex; gap:8px; margin-top:10px }
  input[type="text"], input[type="email"], input[type="tel"], input[type="password"] {
    flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(12,1,1,.15); background:#fff; font-size:14px
  }
  button {
    border:none; cursor:pointer; border-radius:12px; padding:12px 16px; font-weight:700;
    background:var(--orange); color:#fff; transition: transform .08s ease; box-shadow:0 6px 14px rgba(227,68,16,.25)
  }
  button:hover { transform:translateY(-1px) }
  button.secondary { background:#fff; color:#0C0101; border:1px solid rgba(12,1,1,.18); box-shadow:none }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .hint { font-size:13px; color:var(--muted); margin-top:4px }
  .split { display:grid; grid-template-columns:1.2fr .8fr; gap:16px }
  @media (max-width:900px){ .split{ grid-template-columns:1fr } }
  .list { display:flex; flex-wrap:wrap; gap:8px }
  .pill { padding:8px 12px; border-radius:999px; border:1px solid rgba(12,1,1,.12); background:#fff; font-size:13px; cursor:pointer }
  .pill.active { background:#e7fff9; border-color:rgba(49,193,187,.4) }
  .status { font-size:12px; color:#64748b; margin-top:6px }

  .lead-form { display:grid; gap:10px }
  .reward { display:flex; align-items:center; gap:10px; font-weight:700 }
  .reward .lock { font-size:18px }
  .ok { color:#10b981; font-weight:700 }
  .warn { color:#ef4444; font-weight:700 }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="hero">
          <!-- Progress ring -->
          <div class="ring">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <circle class="bg" cx="50" cy="50" r="42"></circle>
              <circle id="ring-fg" class="fg" cx="50" cy="50" r="42"
                stroke-dasharray="264" stroke-dashoffset="264"></circle>
            </svg>
            <!-- Avatar -->
            <div class="avatar" aria-label="Avatar do Sr. Mastrius">
              <!-- Cartoon coach (busto) -->
              <svg viewBox="0 0 128 128">
                <circle cx="64" cy="64" r="62" fill="#fff"/>
                <circle cx="64" cy="50" r="22" fill="#f2d3c2"/>
                <rect x="38" y="84" width="52" height="30" rx="14" fill="#31c1bb"/>
                <path d="M40,94 Q64,80 88,94 L88,112 L40,112 Z" fill="#0C0101" opacity="0.15"/>
                <path d="M48,54 q16,10 32,0" stroke="#0C0101" stroke-width="3" fill="none" opacity=".15"/>
                <circle cx="56" cy="48" r="2.5" fill="#0C0101"/><circle cx="72" cy="48" r="2.5" fill="#0C0101"/>
                <path d="M54,63 q10,6 20,0" stroke="#e34410" stroke-width="3" fill="none"/>
                <rect x="50" y="24" width="28" height="14" rx="7" fill="#0C0101"/>
              </svg>
            </div>
          </div>
          <div>
            <div class="title">Sr. Mastrius ‚Äî English Mastery Coach</div>
            <div class="sub">Bem-vindo! Vamos come√ßar em portugu√™s e, aos poucos, mudar para ingl√™s.</div>
          </div>
        </div>
      </div>
      <div class="badge locked" id="badge">
        <span>üéÅ</span> <span id="badge-text">Recompensa: (N√≠vel + Speaking Test) bloqueado</span>
      </div>
    </header>

    <!-- SCREEN: Welcome -->
    <section id="screen-welcome" class="screen active card">
      <p class="bubble bot">
        Ol√°! Eu sou o <strong>Sr. Mastrius</strong>. Vamos descobrir seu n√≠vel de ingl√™s e liberar uma sess√£o gratuita de speaking?
      </p>
      <div class="row">
        <button id="btnStart">Come√ßar avalia√ß√£o</button>
        <button id="btnLogin" class="secondary">Sou aluno EM</button>
      </div>
      <div class="hint">Dura ~5‚Äì8 min. Primeiras instru√ß√µes em PT-BR; perguntas em ingl√™s.</div>
    </section>

    <!-- SCREEN: Placement -->
    <section id="screen-placement" class="screen">
      <div class="split">
        <div class="card">
          <div class="chat" id="placeChat" aria-live="polite"></div>
          <div class="controls">
            <input id="placeInput" type="text" placeholder="Type your answer in English‚Ä¶" autocomplete="off"/>
            <button id="placeSend">Send</button>
          </div>
          <div class="status" id="placeStatus"></div>
        </div>
        <aside class="card">
          <div class="reward"><span class="lock" id="lock">üîí</span> <span id="rewardText">Resultado bloqueado</span></div>
          <div class="hint">Complete o teste para desbloquear seu diagn√≥stico e a sess√£o gratuita.</div>
          <div style="margin-top:10px">
            <div class="list" id="tags"></div>
          </div>
        </aside>
      </div>
    </section>

    <!-- SCREEN: Lead Gate -->
    <section id="screen-gate" class="screen card">
      <p class="bubble bot">
        √ìtimo trabalho! Para ver seu <strong>diagn√≥stico</strong> (pontos fortes, focos e n√≠vel estimado) e liberar sua <strong>sess√£o gratuita</strong>, preencha:
      </p>
      <form id="leadForm" class="lead-form">
        <input id="leadName"  type="text"  placeholder="Nome completo" required />
        <input id="leadEmail" type="email" placeholder="E-mail" required />
        <input id="leadWhats" type="tel"   placeholder="WhatsApp (com DDD)" required />
        <button type="submit">Ver diagn√≥stico & desbloquear recompensa</button>
      </form>
      <div class="status" id="leadStatus"></div>
    </section>

    <!-- SCREEN: Result -->
    <section id="screen-result" class="screen card">
      <div id="resultArea" class="bubble bot"></div>
      <div class="row" style="margin-top:10px">
        <a class="pill" id="calendly" href="https://calendly.com/carloseduardo-englishmastery/30min" target="_blank" rel="noopener">üìÖ Agendar Speaking Test (30min)</a>
        <button id="goConversation">Ir para Conversa√ß√£o</button>
      </div>
    </section>

    <!-- SCREEN: Login EM -->
    <section id="screen-login" class="screen card">
      <p class="bubble bot">
        Acesso para alunos EM. Digite seu nome e sobrenome e a senha para desbloquear o modo de conversa√ß√£o.
      </p>
      <div class="controls">
        <input id="emName" type="text" placeholder="Nome" />
        <input id="emLast" type="text" placeholder="Sobrenome" />
      </div>
      <div class="controls">
        <input id="emPass" type="password" placeholder="Senha (dica: destrave)" />
        <button id="emEnter">Entrar</button>
      </div>
      <div class="hint">No primeiro acesso, seu login ser√° <em>nome+sobrenome</em> (sem espa√ßos). Pr√≥ximas vezes: basta usar o login salvo.</div>
      <div class="status" id="loginStatus"></div>
    </section>

    <!-- SCREEN: Conversation -->
    <section id="screen-convo" class="screen">
      <div class="split">
        <div class="card">
          <div class="chat" id="convoChat" aria-live="polite"></div>
          <div class="controls">
            <input id="convoInput" type="text" placeholder="Talk to Sr. Mastrius‚Ä¶" autocomplete="off"/>
            <button id="convoSend">Send</button>
          </div>
          <div class="status" id="convoStatus"></div>
        </div>
        <aside class="card">
          <div class="sub"><strong>Temas sugeridos</strong> (por n√≠vel CEFR)</div>
          <div class="list" id="topicList"></div>
          <div class="hint">Sugest√µes ficam mais relevantes com o tempo, conforme seus interesses.</div>
        </aside>
      </div>
    </section>
  </div>

<script>
/* ------------------ State Helpers ------------------ */
const $ = (id)=>document.getElementById(id);
const screens = ["screen-welcome","screen-placement","screen-gate","screen-result","screen-login","screen-convo"];
function show(id){ screens.forEach(s=>$(s).classList.remove("active")); $(id).classList.add("active"); }
function setRing(pct){
  // ring circumference ~ 2œÄr = 2*3.14*42 ‚âà 264
  const total=264; const off = total - total * Math.max(0,Math.min(1,pct));
  $("ring-fg").style.strokeDashoffset = String(off);
}
function addBubble(el, text, who="bot"){
  const d=document.createElement("div"); d.className="bubble "+who; d.textContent=text;
  el.appendChild(d); el.scrollTop = el.scrollHeight;
}

/* ------------------ Welcome ------------------ */
$("btnStart").onclick = ()=>{
  show("screen-placement");
  startPlacement();
};
$("btnLogin").onclick = ()=> show("screen-login");

/* ------------------ Placement Engine ------------------ */
/* Mini-banco de perguntas por faixas (A1/A2/B1). Cada item: {q, key, level, ok: [palavras/frases aceitas], tip} */
const BANK = [
  // A1
  { level:"A1", key:"greet", q:"Hi! What's your name?", ok:["my name is","i'm"], tip:"Say: ‚ÄúI‚Äôm <name>.‚Äù" },
  { level:"A1", key:"origin", q:"Where are you from?", ok:["from","i'm from"], tip:"Use: ‚ÄúI‚Äôm from <city/country>.‚Äù" },
  { level:"A1", key:"likes", q:"What do you like to do in your free time?", ok:["like","love","enjoy"], tip:"Use a verb: ‚ÄúI like‚Ä¶ / I enjoy‚Ä¶‚Äù" },

  // A2
  { level:"A2", key:"routine", q:"Tell me about your typical weekday.", ok:["work","study","wake","usually"], tip:"Use present simple: ‚ÄúI usually‚Ä¶‚Äù" },
  { level:"A2", key:"travel", q:"Do you prefer traveling by plane, car, or bus? Why?", ok:["plane","car","bus","because"], tip:"Compare and give a reason." },
  { level:"A2", key:"past", q:"What did you do last weekend?", ok:["went","watched","visited","stayed","did"], tip:"Use past: ‚ÄúI went‚Ä¶ / I watched‚Ä¶‚Äù" },

  // B1
  { level:"B1", key:"work", q:"Describe a challenge at work or school and how you handled it.", ok:["because","so","but","first","then"], tip:"Explain the situation and what you did." },
  { level:"B1", key:"opinion", q:"Do you think learning English online is as effective as in-person classes?", ok:["i think","in my opinion","depends"], tip:"Give your view and one reason." },
  { level:"B1", key:"goal", q:"What is a specific English goal you want to achieve in 3 months?", ok:["i want","my goal","improve"], tip:"Be concrete: exam, meeting, travel‚Ä¶" },
];

let placeState = {
  step:0, correct:0, wrong:0, levelScore:0, // >0 sobe, <0 desce
  tags:new Set(), // interesses/temas detectados
  started:false, finished:false, maxSteps:7
};

function pickQuestion(){
  // regra simples: come√ßa A1 ‚Üí sobe p/ A2 se score>=2 ‚Üí B1 se score>=4
  let tier="A1";
  if (placeState.levelScore>=4) tier="B1";
  else if (placeState.levelScore>=2) tier="A2";
  const pool = BANK.filter(x=>x.level===tier);
  const used = placeState.step % pool.length;
  return pool[used];
}

function judge(answer, item){
  const a = answer.toLowerCase();
  const hit = item.ok.some(k=>a.includes(k));
  if (hit){ placeState.correct++; placeState.levelScore++; }
  else { placeState.wrong++; placeState.levelScore=Math.max(-2, placeState.levelScore-1); }
  // coletar interesses (tags simples)
  ["travel","music","movie","job","study","family","sport","goal","meeting"].forEach(t=>{
    if (a.includes(t)) placeState.tags.add(t);
  });
  return hit;
}

function placementBotSay(text){ addBubble($("placeChat"), text, "bot"); }
function placementUserSay(text){ addBubble($("placeChat"), text, "user"); }

async function startPlacement(){
  placeState={step:0, correct:0, wrong:0, levelScore:0, tags:new Set(), started:true, finished:false, maxSteps:7};
  $("placeChat").innerHTML="";
  setRing(0); $("badge").classList.add("locked"); $("badge-text").textContent="Recompensa: (N√≠vel + Speaking Test) bloqueado";
  placementBotSay("Perfeito. A partir de agora, responda em ingl√™s. Ready?");
  nextPlacement();
}

function nextPlacement(){
  if (placeState.step>=placeState.maxSteps){
    finishPlacement(); return;
  }
  const item = pickQuestion();
  placementBotSay(item.q);
  $("placeStatus").textContent = `Question ${placeState.step+1} of ${placeState.maxSteps}`;
}

$("placeSend").onclick = ()=>{
  const val = $("placeInput").value.trim();
  if(!val) return;
  $("placeInput").value="";
  placementUserSay(val);

  const item = pickQuestion();
  const ok = judge(val, item);
  placementBotSay(ok ? "Good!" : `Nice try. ${item.tip}`);

  placeState.step++;
  setRing(placeState.step/placeState.maxSteps);
  if (placeState.step>=placeState.maxSteps){ finishPlacement(); }
  else { setTimeout(nextPlacement, 500); }
};

function levelFromScore(score){
  if (score>=5) return "B1";
  if (score>=2) return "A2";
  return "A1";
}
function strengthsWeaknesses(score){
  const s = []; const w=[];
  if (score<=1) { s.push("basic greetings and simple preferences"); w.push("present simple and short answers with clarity"); }
  else if (score<=3) { s.push("everyday topics and basic past actions"); w.push("richer reasons/examples and verb tenses"); }
  else { s.push("work/school topics and opinions"); w.push("cohesion (because/so/but) and more natural phrasing"); }
  return {s,w};
}
function finishPlacement(){
  placeState.finished = true;
  $("badge").classList.remove("locked");
  $("badge-text").textContent = "üéÅ Recompensa desbloqueada (ao final)";
  $("rewardText").textContent = "Complete! Veja seu diagn√≥stico ap√≥s a identifica√ß√£o.";
  $("lock").textContent = "üîì";
  show("screen-gate");
}

/* ------------------ Gate (Lead) ------------------ */
$("leadForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name=$("leadName").value.trim();
  const email=$("leadEmail").value.trim();
  const whats=$("leadWhats").value.trim();
  if(!name || !email || !whats){ $("leadStatus").textContent="Preencha todos os campos."; return; }
  $("leadStatus").textContent="Salvando‚Ä¶";

  // resumo diagn√≥stico
  const level = levelFromScore(placeState.levelScore);
  const {s,w} = strengthsWeaknesses(placeState.levelScore);
  const tags = Array.from(placeState.tags);

  // persist local p/ futuras sess√µes
  localStorage.setItem("em_lead", JSON.stringify({name,email,whats, level, tags, ts:Date.now()}));

  // tenta enviar ao backend (upsert)
  try{
    const r = await fetch("/lead", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        name,email,whats,
        placement:{ score:placeState.levelScore, level, correct:placeState.correct, wrong:placeState.wrong, tags },
        meta:{ ua:navigator.userAgent, t:Date.now() }
      })
    });
    // ignora erro; segue fluxo
    await r.text().catch(()=>{});
  }catch(_){}

  // mostra resultado
  const diag = [
    `Estimated level: ${level}`,
    `You do well with: ${s.join(", ")}`,
    `Focus next: ${w.join(", ")}`,
    tags.length? `Topics you mentioned: ${tags.join(", ")}` : ""
  ].filter(Boolean).join("\n");

  $("resultArea").textContent = `Your diagnostic\n\n${diag}\n\nGreat job! Click below to book your free speaking test.`;
  show("screen-result");
});

/* ------------------ Login EM ------------------ */
$("emEnter").onclick = ()=>{
  const n=$("emName").value.trim(); const l=$("emLast").value.trim(); const p=$("emPass").value.trim();
  if(!n || !l || !p){ $("loginStatus").textContent="Preencha nome, sobrenome e senha."; return; }
  if(p!=="destrave"){ $("loginStatus").innerHTML="<span class='warn'>Senha incorreta.</span>"; return; }
  const login = (n+l).replace(/\s+/g,"").toLowerCase();
  localStorage.setItem("em_login", login);
  $("loginStatus").innerHTML = `<span class='ok'>Modo Conversa√ß√£o liberado.</span> Seu login: <strong>${login}</strong> (guardado).`;
  setTimeout(()=> show("screen-convo"), 800);
};

/* ------------------ Conversation Mode ------------------ */
const TOPICS = {
  A1:["Daily greetings","Food & drinks","Family & friends","Hobbies"],
  A2:["Travel & trips","Routine & schedules","Shopping & services","Health basics"],
  B1:["Work meetings","Opinions & debates","Past projects","Plans & goals"]
};
function renderTopics(level){
  const box=$("topicList"); box.innerHTML="";
  (TOPICS[level]||TOPICS.A2).forEach(t=>{
    const b=document.createElement("button"); b.className="pill"; b.textContent=t;
    b.onclick=()=> convoSend(`Let‚Äôs practice: ${t}. Ask me questions and help me improve.`);
    box.appendChild(b);
  });
}

function convoAdd(text, who="bot"){ addBubble($("convoChat"), text, who); }
async function convoSend(text){
  if(!text){ text = $("convoInput").value.trim(); $("convoInput").value=""; }
  if(!text) return;
  convoAdd(text,"user");
  $("convoStatus").textContent="Thinking‚Ä¶";
  try{
    const r = await fetch("/respond",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ text })});
    const j = await r.json();
    if(!r.ok || !j?.ok){ convoAdd("Server error, please try again.","bot"); }
    else { convoAdd(j.text,"bot"); }
  }catch(_){ convoAdd("Connection error.","bot"); }
  $("convoStatus").textContent="";
}

$("convoSend").onclick = ()=>convoSend();
$("convoInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") convoSend(); });

/* On load: personalize topics by last placement */
(function init(){
  const lead = JSON.parse(localStorage.getItem("em_lead")||"null");
  const level = lead?.level || "A2";
  renderTopics(level);
})();
</script>
</body>
</html>
