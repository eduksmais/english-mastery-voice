// script.js ‚Äî front completo: intake SPIN + placement Groq + chat
const GROQ_API = "/api/chat";
const FORMSPREE_LEADS = "https://formspree.io/f/mdkproyy";
const FORMSPREE_STUDENTS = "https://formspree.io/f/xjkpqvjp";

const $ = (s) => document.querySelector(s);
const screens = ["welcome","intake","placement","result","login","chat"];
function show(id){ screens.forEach(sc=>$("#"+sc).classList.toggle("active", sc===id)); }

// ===== 1. navega√ß√£o =====
$("#btnStartIntake").onclick = ()=>show("intake");
$("#btnStudentLogin").onclick = ()=>show("login");
$("#btnBackLogin").onclick = ()=>show("welcome");

// ===== 2. INTAKE (SPIN) =====
const spinQs = [
  {id:"situation",q:"Qual √© sua rela√ß√£o atual com o ingl√™s?"},
  {id:"problem",q:"O que mais te incomoda quando tenta usar ou estudar ingl√™s?"},
  {id:"implication",q:"Como isso tem te atrapalhado no trabalho ou na vida pessoal?"},
  {id:"need",q:"Se voc√™ resolvesse isso nos pr√≥ximos meses, o que mudaria pra voc√™?"}
];
let spinData = {}, spinIndex = 0;
const intakeArea = $("#intakeArea");
renderSpin();

function renderSpin(){
  if(spinIndex>=spinQs.length){ return startPlacement(); }
  const q = spinQs[spinIndex];
  intakeArea.innerHTML = `
    <h3>${q.q}</h3>
    <textarea id="spinAns" rows="4" placeholder="Escreva aqui..."></textarea>
    <button id="nextSpin" class="btn btn-primary">Continuar</button>
  `;
  $("#nextSpin").onclick = async ()=>{
    const val = $("#spinAns").value.trim(); if(!val) return;
    spinData[q.id]=val;
    // envia p/ Groq (gera follow-up leve)
    const reply = await groqReply([{role:"user",content:val}],
      "Act as an empathetic interviewer. Give one short encouraging reply.");
    intakeArea.innerHTML += `<p class="ai-reply">${reply}</p>`;
    setTimeout(()=>{ spinIndex++; renderSpin(); },800);
  };
}

// ===== 3. PLACEMENT =====
let questions=[], qIndex=0, score={A1:0,A2:0,B1:0}, total=6;
async function startPlacement(){
  show("placement");
  // perguntas fixas + Groq valida
  questions=[
    {q:"Complete: I ___ a teacher.",opts:["is","are","am"],a:2,l:"A1"},
    {q:"Choose: She ___ to the gym every morning.",opts:["go","goes","going"],a:1,l:"A1"},
    {q:"What does 'I‚Äôm used to waking up early' mean?",opts:["I wake up early often","I hate waking up early","I rarely wake up early"],a:0,l:"A2"},
    {q:"Choose the correct sentence:",opts:["He can to drive","He can drives","He can drive"],a:2,l:"A2"},
    {q:"Fill in: If I ___ more time, I would study English every day.",opts:["have","had","would have"],a:1,l:"B1"},
    {q:"Which sentence is more natural?",opts:["She said me that‚Ä¶","She told me that‚Ä¶","She told to me that‚Ä¶"],a:1,l:"B1"}
  ];
  renderQ();
}
function renderQ(){
  const q=questions[qIndex]; if(!q) return endPlacement();
  $("#questionCounter").textContent=`Pergunta ${qIndex+1} de ${total}`;
  $("#placementBar").style.width=`${(qIndex/total)*100}%`;
  $("#questionArea").innerHTML = `
    <h3>${q.q}</h3>
    ${q.opts.map((o,i)=>`<button class="option-btn" data-i="${i}">${o}</button>`).join("")}
  `;
  document.querySelectorAll(".option-btn").forEach(b=>b.onclick=(e)=>checkAns(parseInt(e.target.dataset.i)));
}
async function checkAns(i){
  const q=questions[qIndex];
  const correct=(i===q.a);
  if(correct) score[q.l]++;
  const feedback=await groqReply(
    [{role:"user",content:`Question: ${q.q}\nAnswer chosen: ${q.opts[i]}\nCorrect: ${correct}`}],
    "Give a 1-sentence encouraging comment (in learner's level English).");
  $("#questionArea").innerHTML+=`<p class='ai-reply'>${feedback}</p>`;
  qIndex++; setTimeout(renderQ,900);
}
function endPlacement(){
  const level=Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];
  $("#levelText").textContent=level;
  $("#diagnosticBox").innerHTML=`<p><b>For√ßas:</b> ${strengths(level)}</p><p><b>Oportunidades:</b> ${weakness(level)}</p>`;
  show("result");
}

// ===== 4. RESULT + LEAD =====
$("#leadForm").onsubmit=async(e)=>{
  e.preventDefault();
  const data={
    name:$("#leadName").value, email:$("#leadEmail").value, whats:$("#leadWhats").value,
    ...spinData, level:$("#levelText").textContent
  };
  await fetch(FORMSPREE_LEADS,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify(data)});
  $("#leadForm").classList.add("hidden"); $("#rewardBox").classList.remove("hidden");
};

// ===== 5. LOGIN =====
$("#btnLogin").onclick=()=>{
  const pass=$("#studentPass").value.trim();
  const name=$("#studentName").value.trim();
  if(pass!=="destrave"||!name)return;
  localStorage.setItem("emStudent",name);
  fetch(FORMSPREE_STUDENTS,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({name,loginAt:new Date().toISOString()})});
  show("chat"); addMsg("ai","Bem-vindo(a)! Vamos conversar em ingl√™s? üòä");
};

// ===== 6. CHAT =====
const chatBox=$("#chatBox");
function addMsg(role,txt){
  const el=document.createElement("div");
  el.className=`chat-message ${role==="user"?"user-message":"ai-message"}`;
  el.innerHTML=txt; chatBox.appendChild(el); chatBox.scrollTop=chatBox.scrollHeight;
}
$("#sendBtn").onclick=async()=>{
  const t=$("#userInput").value.trim(); if(!t)return;
  $("#userInput").value=""; addMsg("user",t);
  const r=await groqReply([{role:"user",content:t}],
    "You are Mastrius, an English coach. Reply naturally, CEFR-adjusted, friendly, concise.");
  addMsg("ai",r);
};

// ===== util =====
async function groqReply(msgs,system){
  try{
    const res=await fetch(GROQ_API,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:[{role:"system",content:system},...msgs]})});
    const data=await res.json(); return data.choices?.[0]?.message?.content||"";
  }catch(e){return"(connection issue)";}
}
function strengths(l){return l==="A1"?"vocabul√°rio b√°sico e clareza":
 l==="A2"?"flu√™ncia em t√≥picos do dia a dia":"capacidade de expressar opini√µes com confian√ßa";}
function weakness(l){return l==="A1"?"verbos e estrutura de frases":
 l==="A2"?"precis√£o gramatical e variedade de vocabul√°rio":"naturalidade e amplia√ß√£o lexical";}
